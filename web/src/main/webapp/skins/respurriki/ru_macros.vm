### Generate a dropdown item for button
###
### @param actionurl The URL this entry points to
### @param linktext The menu item text
###
#macro(ru_dropdown_item $actionurl $linktext)
<li><a href="$actionurl">$linktext</a></li>
#end

### Generate button input
###
### @param linktext the button text
### @param attributes class, id, html5 dom data
###
#macro(ru_button $linktext $attributes)
<button type="button" $attributes>$linktext</button>
#end

### Generate anchor
###
### @param linktext the button text
### @param linkurl the url for the anchor
### @param attributes class, id, html5 dom data
###
#macro(ru_anchor $linktext $linkurl $attributes)
<a href="$linkurl" $attributes>$linktext</a>
#end

### Generate breadcrumb
###
### @param linktext the button text
### @param linkurl the url for the anchor
### @param attributes class, id, html5 dom data
###
#macro(ru_breadcrumb )
    <ol class="breadcrumb">
        <li><a href="#">GWF</a></li>
        <li><a href="#">Selling Geometry</a></li>
        <li><a href="#">Introduction</a></li>
        <li class="active">Introduction to Geometry</li>
    </ol>
#end

#**
  * Macro for verifying if an entry in the nav panel is active
  *
  *#
#macro(ru_checkActive $docname $result)
    #if($doc.fullName == $docname)
        #set ($result = $util.null)
        #if($doc.space == "MyCurriki" && "$!request.user" != "")
            #ru_setVariable ("$result" false)
        #else
            #ru_setVariable ("$result" true)
        #end
    #end
#end

#** Hack to restore the parameter-by-reference pattern that was possible
    in velocity 1.6. Pulled from XWiki 3.3
* Assign a value to a variable, given by its name. The purpose of this macro is to emulate call by macro expansion,
* which was available in velocity versions up to 1.6, but was removed in 1.7.
*
* @param variableName the name of the variable to set, a String; when the macro returns, a variable named that way will be created with the output value
* @param value the value to assign
*###
#macro(ru_setVariable $variableName $value)
## Only do this if the variable name is really a valid variable name
    #if ($variableName.matches('[a-zA-Z_][a-zA-Z0-9_-]*'))
        #evaluate("${escapetool.h}set(${escapetool.d}${variableName}=${escapetool.d}value)")
    #elseif ($variableName.matches('\$[a-zA-Z_][a-zA-Z0-9_-]*'))
        #evaluate("${escapetool.h}set(${variableName}=${escapetool.d}value)")
    #end
#end

#**
 * Begin the navigation panel
 *
*#
#macro(ru_beginNavigationPanel $homerollovertext)
    <div id="wrapper-sidebar">
        #set($active = false)
        #ru_checkActive("Main.WebHome" $active)
        <div class="panel panel-primary">
            <div class="panel-heading">Panel heading</div>
            <div class="list-group">
                <a title="" class="list-group-item href="$xwiki.getURL("Main.WebHome")">$msg.get("panel.navigation.home")</a>
            </div>
        </div>
#end

#**
  * End the navigation panel
  *
  *#
#macro(ru_endNavigationPanel) 
  </div>
#end ##}


#**
  * Displays a navigation category, with sub-elements
  *
  *#
#macro(ru_navigationCategory $text $rollovertext $link $expanded $items) 
  #set($iniexp = $expanded)
  #if($doc.space.startsWith("Coll_")) 
      #set ($expanded = $util.null)#setVariable ("$expanded" false)#set($expanded=false) 
    #set($cookiebase = "${context.user}_asset_")
  #else ##}{
    #set($cookiebase = "${context.user}_")
  #end ##}  
  #if(!$navcatcounter)  
    #set($navcatcounter = 1)
  #else ##}{
    #set($navcatcounter = $navcatcounter + 1)
  #end ##}	  
  #set($id = "currikinavcategory_${navcatcounter}")
  #if($expanded == true) 
    #set($cookiemagic = "if(expanded) createCookie('${cookiebase}${id}','false', ''); else eraseCookie('${cookiebase}${id}');")
  #else ##}{
    #set($cookiemagic = "if(expanded) eraseCookie('${cookiebase}${id}'); else createCookie('${cookiebase}${id}', 'true', '');")
  #end ##}	  
  #set($exp2 = "")
  #set($exp2 = $xwiki.getUserPreferenceFromCookie("${cookiebase}$id"))
  #if(!$exp2.equals("")) 
    #if($exp2 == 'true') 
      #set($expanded = true)
    #else ##}{
      #set($expanded = false)
    #end ##}
  #end ##}	  
  #set($active = false)
  #foreach($item in $items) 
    #checkActive($item.get(1) $active)
  #end ##}	  
  #set($theCategLink = $link)
  #normalizelink($theCategLink)
<div class="panel panel-primary" id="${id}">
    <div class="panel-heading">$text</div>
  <div class="list-group">
  #foreach($item in $items) 
    #set($active = false)
    #checkActive($item.get(1) $active)
    #set($theItemLink = $item.get(1))
    #normalizelink($theItemLink)
    #set($linktitle = "")
    #if($item.size()>2) #set($linktitle="title='$item.get(2)'") #end
    <a class="list-group-item #if($active)selected#end" href="{pre}${theItemLink}{/pre}">$item.get(0)</a>
    #set($linktitle = "")
  #end ##}
  </div>
  </div> ##}
  #set($expanded=$iniexp) ##rolling back the parameter to initial value so it won't affect future calls to this macro
#end  ##}


#**
 * Displays a navigation entry (without sub-elements)
 *#
#macro(ru_navigationTopLevelEntry $text $link)
#set($active = false)
#checkActive($link $active)
<div class="curriki-nav-tlentry#if($active)active selected#end" #if(!$active) onmouseover="addClass(this, 'curriki-nav-tlentryactive')" onmouseout="rmClass(this, 'curriki-nav-tlentryactive')" #end>
<div class="curriki-nav-header"><h4>[$text>$link]</h4></div>
</div>
#end

#macro(ru_submitButton $name $shortcut $value)
<input class="btn btn-default" type="submit" name="$name"#if($keyboardShortcutsEnabled) title="$shortcut"#end value="$value"/>
#end

#**
 * Displays a submit button for the editor. This macro calls submitButton,
 * composing all its parameters based on the action's identifier and the
 * identifier of the corresponding localized resources.
 * @param action The identifier of the button's action.
 * @param resourceIdentifier The key used to identify the localized resources.
 *#
#macro(ru_editActionButton $action $resourceIdentifier)
#submitButton("action_${action}", $msg.get("core.shortcuts.edit.${resourceIdentifier}"), $msg.get($resourceIdentifier))
#end

#macro(ru_listMessages)
#set($the_space = "Messages_${doc.space}")
#set($messages = $xwiki.getSpaceDocsName($the_space))
#set($options = ["success", "info", "warning", "danger"])
#set($counter = 0)
#foreach($message_row in $messages)
#set($message_doc = $xwiki.getDocument($the_space, $message_row))
#set($messageObj = $message_doc.getObject("XWiki.ArticleClass"))
#if("$!messageObj" != "")
#if($counter == 3)
 #set($counter = 0)
#end
{{html clean="false"}}
<div class="alert alert-$options[$counter]">
<h4>{{/html}} $messageObj.getProperty("title").value {{html clean="false"}}</h4>
{{/html}} $messageObj.get("content") {{html clean="false"}}
</div>
{{/html}}
#set($counter = $counter + 1)
#end
#end
#end

### Code from table of contents panel
###
###
#macro(ru_tocAssetSubtype $assetDoc)
    #set($rType = $assetDoc.getAssetClass().name.replaceAll("^.*\056", "").replaceAll("Asset$", ""))
    #if("$!rType" == "")
        #set($rType = "Unknown")
    #end
#end
##
#macro(ru_tocToJSON $curDoc $lastAssetName $lastAssetJSON) 
    ## set Current asset information
    #set($curTitle = $curDoc.getDisplayTitle().replaceAll('\\', '\\\\').replaceAll("'", "\\'"))
    #set($curDesc = $curDoc.getDescription().replaceAll('\\', '\\\\').replace("'", "&#39;").replaceAll("[\n|\r]+", "<br />"))
    #set($curDate = $!xwiki.formatDate($curDoc.contentUpdateDate, $msg.get("mycurriki.dateFormat")))
    #set($curHref = $xwiki.getURL($curDoc.fullName, 'view'))
    #set($curSelected = "")
    #if($curDoc.fullName == $doc.fullName)
        #set($curSelected = " toc-selected")
    #end
    #ru_tocAssetSubtype($curDoc)
    #set($curType = $rType)
    ## Get Framework items
    #set($curFW = "")
    #set($subj = $!curDoc.getValue('fw_items'))
    #set($isFirst = true)
    #foreach($item in $subj)
        #if($item != "FW_masterFramework.WebHome")
            #if($isFirst)
                #set($isFirst = false)
            #else
                #set($curFW = "$curFW, ")
            #end
            #set($curFW = "$curFW'$item'")
        #end
    #end 
    #set($curFW = "[ $curFW ]")
    ## Get educational levels
    #set($curLvl = "")
    #set($levl = $!curDoc.getValue('educational_level'))
    #set($isFirst = true)
    #foreach($item in $levl) 
        #if($isFirst) 
            #set($isFirst = false)
        #else 
            #set($curLvl = "$curLvl, ")
        #end 
        #set($curLvl = "$curLvl'$item'")
    #end
    #set($curLvl = "[ $curLvl ]")
    ## Get icts
    #set($curICT = "")
    #set($ict = $!curDoc.getValue('instructional_component'))
    #set($isFirst = true)
    #foreach($item in $ict)
        #if($isFirst)
            #set($isFirst = false)
        #else
            #set($curICT = "$curICT, ")
        #end
        #set($curICT = "$curICT'$item'")
    #end
    #set($curICT = "[ $curICT ]")
    ##
    ## Create json
    #if($curDoc.isFolder())
        ## Current item is a composite -- so need to get children
        #set($curSubJSON = "")
        #set($curSublist = $curDoc.getSubassetList())
        #foreach($subItem in $curSublist)
            #if($subItem == $lastAssetName)
                    #set($curSubJSON = "$curSubJSON,$lastAssetJSON")
            #else
                #set($subAsset = $!xwiki.curriki.fetchAssetOrNull($subItem))
                #if($subAsset)
                    #set($subSelected = "")
                    #if($subAsset.fullName == $doc.fullName)
                        #set($subSelected = " toc-selected")
                    #end
                    #ru_tocAssetSubtype($subAsset)
                    #set($subTitle = $subAsset.getDisplayTitle().replaceAll('\\', '\\\\').replaceAll("'", "\\'"))
                    #set($subDesc = $subAsset.getDescription().replaceAll('\\', '\\\\').replace("'", "&#39;").replaceAll("[\n|\r]+", "<br />"))
                    #set($subDate = $!xwiki.formatDate($subAsset.contentUpdateDate, $msg.get("mycurriki.dateFormat")))
                    #set($subHref = $xwiki.getURL($subAsset.fullName, 'view'))
                    ## Get Framework items
                    #set($subFW = "")
                    #set($subj = $!subAsset.getValue('fw_items'))
                    #set($isFirst = true)
                    #foreach($item in $subj)
                        #if($item != "FW_masterFramework.WebHome")
                            #if($isFirst) 
                                #set($isFirst = false)
                            #else
                                #set($subFW = "$subFW, ")
                            #end
                            #set($subFW = "$subFW'$item'")
                        #end
                    #end
                    #set($subFW = "[ $subFW ]")
                    ## Get educational levels
                    #set($subLvl = "")
                    #set($levl = $!subAsset.getValue('educational_level'))
                    #set($isFirst = true)
                    #foreach($item in $levl)
                        #if($isFirst) 
                            #set($isFirst = false)
                        #else
                            #set($subLvl = "$subLvl, ")
                        #end
                        #set($subLvl = "$subLvl'$item'")
                    #end
                    #set($subLvl = "[ $subLvl ]")
                    ## Get icts
                    #set($subICT = "")
                    #set($ict = $!subAsset.getValue('instructional_component'))
                    #set($isFirst = true)
                    #foreach($item in $ict)
                        #if($isFirst) 
                            #set($isFirst = false)
                        #else
                            #set($subICT = "$subICT, ")
                        #end
                        #set($subICT = "$subICT'$item'")
                    #end
                    #set($subICT = "[ $subICT ]")
                    ##
                    #set($subSubCategory = "")
                    #set($subSubCategory = $subAsset.categorySubtype)
                    #if("$!subSubCategory" == "") 
                        #set($subSubCategory = "unknown")
                    #end
                    ##
                    #if($subAsset.isFolder()) 
                        #set($curSubJSON = "$curSubJSON,{collectionPage:'$!{subAsset.fullName}', displayTitle: '$!{subTitle}', description:'$!{subDesc}', lastUpdated:'$!{subDate}', fwItems:$!{subFW}, levels:$!subLvl, ict:$!subICT, assetType:'$!{rType}', category:'$!{subAsset.category}', subcategory:'$!{subSubCategory}', addCls:'$!{subSelected}', href:'$!{subHref}', leaf:false}")
                    #else ## Not isFolder()
                        #set($curSubJSON = "$curSubJSON,{assetpage:'$!{subAsset.fullName}', displayTitle: '$!{subTitle}', description:'$!{subDesc}', lastUpdated:'$!{subDate}', fwItems:$!{subFW}, levels:$!subLvl, ict:$!subICT, assetType:'$!{rType}', category:'$!{subAsset.category}', subcategory:'$!{subSubCategory}', addCls:'$!{subSelected}', href:'$!{subHref}', leaf:true}")
                    #end
                #end
            #end
        #end ##end foreach
        #set($curSubJSON = $curSubJSON.replaceAll("^,", ""))
        ##
        #set($curSubCategory = "")
        #set($curSubCategory = $curDoc.categorySubtype)
        #if("$!curSubCategory" == "") 
            #set($curSubCategory = "unknown")
        #end
        ##
        #set($curJSON = "{collectionPage:'$!{curDoc.fullName}', displayTitle: '$!{curTitle}', description:'$!{curDesc}', lastUpdated:'$!{curDate}', fwItems:$!{curFW}, levels:$!curLvl, ict:$!curICT, assetType:'$!{curType}', category:'$!{curDoc.category}', subcategory:'$!{curSubCategory}', addCls:'$!{curSelected}', href:'$!{curHref}', expanded: true, children:[$!{curSubJSON}]}")
    #else ##  Not isFolder()
        #set($curSubCategory = "")
        #set($curSubCategory = $curDoc.categorySubtype)
        #if("$!curSubCategory" == "") 
            #set($curSubCategory = "unknown")
        #end
        #set($curJSON = "{assetpage:'$!{curDoc.fullName}', displayTitle: '$!{curTitle}', description:'$!{curDesc}', lastUpdated:'$!{curDate}', fwItems:$!{curFW}, levels:$!curLvl, ict:$!curICT, assetType:'$!{curType}', category:'$!{curDoc.category}', subcategory:'$!{curSubCategory}', addCls:'$!{curSelected}', href:'$!{curHref}', leaf: true}")
    #end
#end
## End macro

#macro(ru_getTOC )
    #if($doc.space.startsWith("Coll_") && $doc.hasAccessLevel("view") && !$doc.isNew())
        ## Reverse breadcrumb (we need to work bottom to top)
        #set($bc = "")
        #set($emptyBC = false)
        #foreach($bcItem in $request.bc.split(";")) 
            #if($bcItem.startsWith('Coll_') && !$bcItem.endsWith('.WebHome') && $bcItem != "${doc.fullName}") 
                #set($bc = "$bcItem;$bc")
            #end
        #end
        #set($bc = $bc.replaceAll(";$", ""))
        #if($bc == "") 
            #set($emptyBC = true)
        #end
        #set($bc = "${doc.fullName};$bc")

        #set($lastAssetName = "X")
        #set($lastAssetJSON = "")
        #set($lastAssetIsCollection = false)

        #foreach($bcItem in $bc.split(";")) 
            #set($curDoc = $xwiki.curriki.fetchAssetOrNull($bcItem))
            #if($curDoc) 
                #ru_tocToJSON($curDoc $lastAssetName $lastAssetJSON)
                #set($lastAssetName = $curDoc.fullName)
                #set($lastAssetJSON = $curJSON)
                #set($lastAssetIsCollection = $curDoc.isCollection())
            #end
        #end

        #if($emptyBC) 
            ## Here we need to see if there are any more parents we can add
            #foreach($i in [1..50])  ## There is no while loop in velocity (nor break)
                #if($lastAssetName != "" && !$lastAssetIsCollection) 
                    #set($sql = ", BaseObject as composite, BaseObject as subasset, StringProperty as cprops, StringProperty as sprops where doc.name != 'Favorites' and doc.name != 'WebHome' and composite.name=doc.fullName and composite.className='CurrikiCode.CompositeAssetClass' and composite.id=cprops.id.id and cprops.id.name='type' and (cprops.value='collection' or cprops.value='curriki_document') and subasset.name=doc.fullName and subasset.id=sprops.id.id and subasset.className='CurrikiCode.SubAssetClass' and sprops.id.name='assetpage' and sprops.value='${lastAssetName}' order by doc.name")
                    #set($parentList = $xwiki.searchDocuments($sql))
                    #if($parentList.size() == 1) 
                        #foreach($parentPage in $parentList) 
                            #set($curDoc = $!xwiki.curriki.fetchAssetOrNull($parentPage))
                            #if($curDoc) 
                                #ru_tocToJSON($curDoc $lastAssetName $lastAssetJSON)
                                #set($lastAssetName = $curDoc.fullName)
                                #set($lastAssetJSON = $curJSON)
                                #set($lastAssetIsCollection = $curDoc.isCollection())
                                #set($bc = "$bc;$parentPage")
                            #else
                                #set($lastAssetName = "")
                            #end
                        #end
                    #else
                        #set($lastAssetName = "")
                    #end
                #end
            #end
        #end
        #if("$lastAssetJSON" == "") 
            #set($lastAssetJSON = "{}")
        #end
        {{html clean="false"}}
        <script type="text/javascript">
        /* <![CDATA[ */
        jQuery.noConflict();
        jQuery(document).ready(function() {
            var json_data = JSON.stringify($lastAssetJSON);
            var json_objects = jQuery.parseJSON(json_data);
            var html_output = '';
            var html_sub_output = '<ul><li><a href="#">sub item 1</a></li><li><a href="#">sub item 2</a></li></ul>';
            jQuery.each(json_objects.children, function(){
                html_output += '<li><a href="' + this.href + '">' + this.displayTitle + '<i class="icon-check-sign"></i></a>' + html_sub_output + '</li>';
            });
            jQuery('#wrapper-toc').append('<ul>' + html_output + '</ul>');
        });

        /*
        Ext.ns('Curriki.data.toc');
        Curriki.data.toc.bc = "$bc";
        Curriki.data.toc.tocData = $lastAssetJSON;
        Curriki.data.toc.selected = "$doc.fullName";
        */
        /* ]]> */
        </script>
        <div id="wrapper-toc">
            
        </div>
        {{/html}}
    #end
#end

#macro(ru_javascripttest )
{{html clean="false"}}
<script type="text/javascript">
    /* <![CDATA[ */
    alert('Im alive!');
/* ]]> */
</script>
{{/html}}
#end

#macro(ru_showdialog )
    {{html clean="false"}}
    <div id="dialog-message" title="hey there!">
        <p>
        Hello im a dialog that you can close
        </p>
        <iframe src="http://www.boliviaweb.com/" width="100%"></iframe>
    </div>

    <script type="text/javascript">
        /* <![CDATA[ */
        jQuery.noConflict();
        jQuery(document).ready(function() {
            jQuery( "#dialog-message" ).dialog({
                modal: true,
                minWidth: 400,
                minHeight: 300,
              });
        });
    /* ]]> */
    </script>
    {{/html}}
#end